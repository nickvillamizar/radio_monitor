<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Radio Monitor â€” Panel en Vivo</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header class="header">
    <div class="container header-grid">
      <div>
        <h1>ğŸ“» Radio Monitor</h1>
        <p class="subtitle">DetecciÃ³n automÃ¡tica en vivo â€” Actualizaciones en tiempo real</p>
      </div>
      <div class="header-actions">
        <div id="sync-status" class="small-muted" style="color: #00e8a2;">âœ“ Sincronizado (auto-refresh activo)</div>
        <button id="refresh-btn" class="btn-outline" title="Forzar actualizaciÃ³n ahora">ğŸ”„ Actualizar</button>
      </div>
    </div>
  </header>

  <main class="container main-grid">
    <aside class="left-col">
      <!-- TOP CANCIONES - ELEMENTO PRINCIPAL -->
      <section class="card">
        <div class="card-header">
          <h3>ğŸµ Top canciones en vivo</h3>
          <div class="card-actions">
            <select id="top-limit" class="select-sm">
              <option value="20">Top 20</option>
              <option value="30" selected>Top 30</option>
              <option value="50">Top 50</option>
            </select>
            <button id="export-top-csv" class="btn-ghost" title="Descargar en CSV">ğŸ“¥</button>
          </div>
        </div>
        <div class="list" id="top-songs-list">
          <div class="empty">Cargando canciones...</div>
        </div>
      </section>

      <!-- INFO DE TRANSPARENCIA -->
      <section class="card" style="padding: 1rem; background: rgba(0,232,162,0.05); border-left: 3px solid #00e8a2;">
        <p style="font-size: 0.85rem; color: #aaa; margin: 0; line-height: 1.5;">
          <strong style="color: #00e8a2;">â„¹ï¸ MÃ©todo de detecciÃ³n:</strong><br>
          ğŸ”Š <strong>ICY</strong> = Metadata del stream<br>
          ğŸ™ï¸ <strong>AudD</strong> = Reconocimiento de audio<br>
          ğŸ¤– <strong>PredicciÃ³n</strong> = AnÃ¡lisis estadÃ­stico inteligente<br>
          ğŸ“Š <strong>Fallback</strong> = Sin identificaciÃ³n
        </p>
      </section>
    </aside>

    <section class="right-col">
      <!-- ÃšLTIMAS REPRODUCCIONES - ELEMENTO CRÃTICO -->
      <section class="card">
        <div class="card-header">
          <h3>ğŸ“¡ Ãšltimas reproducciones (tiempo real)</h3>
          <div class="card-actions">
            <input id="filter-play" class="input-sm" placeholder="Buscar..." style="max-width: 150px;"/>
            <button id="export-plays-csv" class="btn-ghost" title="Descargar en CSV">ğŸ“¥</button>
          </div>
        </div>
        <div class="table-wrapper small-scroll">
          <table class="table-compact" id="latest-table">
            <thead>
              <tr>
                <th>Hora</th>
                <th>Emisora</th>
                <th>Artista</th>
                <th>TÃ­tulo</th>
                <th style="width: 60px;">Fuente</th>
              </tr>
            </thead>
            <tbody id="plays-tbody">
              <tr><td colspan="5" style="text-align: center; color: #999;">Cargando reproducciones...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- ESTADÃSTICAS RÃPIDAS -->
      <section class="card small-cards">
        <div class="card-short">
          <h4>ğŸ“Š EstadÃ­sticas</h4>
          <div style="font-size: 0.9rem; color: #ccc; line-height: 2;">
            <div>ğŸµ Canciones Ãºnicas: <strong id="stat-unique-songs">â€”</strong></div>
            <div>ğŸ‘¤ Artistas: <strong id="stat-unique-artists">â€”</strong></div>
            <div>ğŸ“» Emisoras activas: <strong id="stat-active-stations">â€”</strong></div>
          </div>
        </div>

        <div class="card-short">
          <h4>âœ… Calidad de DetecciÃ³n</h4>
          <div style="font-size: 0.9rem; color: #ccc; line-height: 2;">
            <div>ğŸ”Š ICY: <strong id="stat-icy" style="color: #4caf50;">â€”</strong></div>
            <div>ğŸ™ï¸ AudD: <strong id="stat-audd" style="color: #2196f3;">â€”</strong></div>
            <div>ğŸ¤– PredicciÃ³n: <strong id="stat-prediccion" style="color: #9c27b0;">â€”</strong></div>
            <div>ğŸ“Š Fallback: <strong id="stat-fallback" style="color: #ff9800;">â€”</strong></div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <footer class="footer">
    <div class="container">
      <small>Radio Monitor â€” Sistema de DetecciÃ³n Profesional</small>
    </div>
  </footer>

  <script>
    // ============================================================================
    // CONFIGURACIÃ“N
    // ============================================================================
    const CONFIG = {
      AUTO_REFRESH_INTERVAL: 15000, // 15 segundos
      TOP_DEFAULT_LIMIT: 30,
    };

    // ============================================================================
    // API ENDPOINTS (SIMPLIFICADO)
    // ============================================================================
    const api = {
      topSongs: (limit) => `/api/stats/top_songs?limit=${limit}`,
      latestPlays: () => `/api/stats/top_songs?limit=100`, // Ãšltimas 100 canciones
    };

    // ============================================================================
    // UTILIDADES
    // ============================================================================
    function showNotification(message, type = 'success', duration = 3000) {
      const notification = document.createElement('div');
      const bgColor = type === 'error' ? '#ff4c4c' : type === 'warning' ? '#ff9800' : '#00e8a2';
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${bgColor};
        color: white;
        padding: 12px 16px;
        border-radius: 6px;
        font-weight: 600;
        z-index: 10000;
        animation: slideIn 0.3s ease;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, duration);
    }

    function rowsToCSV(rows, headers) {
      const esc = v => `"${String(v || '').replace(/"/g, '""')}"`;
      const head = headers.map(esc).join(',');
      const body = rows.map(r => headers.map(h => esc(r[h] || '')).join(',')).join('\n');
      return head + '\n' + body;
    }

    function formatTime(isoString) {
      const date = new Date(isoString);
      return date.toLocaleString('es-ES', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function getSourceBadge(fuente) {
      const badges = {
        'icy': 'ğŸ”Š ICY',
        'audd': 'ğŸ™ï¸ AudD',
        'prediccion': 'ğŸ¤– PREDICCIÃ“N',
        'fallback': 'ğŸ“Š Fallback',
        'plan_b': 'ğŸ¤– Plan B'
      };
      return badges[fuente] || 'â“ ' + fuente;
    }

    // ============================================================================
    // CARGAR TOP CANCIONES
    // ============================================================================
    async function loadTopSongs() {
      try {
        const limit = parseInt(document.getElementById('top-limit').value || 30);
        const res = await fetch(api.topSongs(limit));
        
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        
        const list = document.getElementById('top-songs-list');
        
        if (!data || data.length === 0) {
          list.innerHTML = '<div class="empty">No hay canciones registradas aÃºn</div>';
          return;
        }

        list.innerHTML = data.map((song, idx) => `
          <div class="list-item" style="padding: 0.75rem; border-bottom: 1px solid #333;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                <div style="font-weight: bold; color: #00e8a2; min-width: 30px;">#${idx + 1}</div>
                <div>
                  <div style="font-weight: 600; color: #fff;">${song.titulo || 'â€”'}</div>
                  <div style="font-size: 0.9rem; color: #aaa;">${song.artista || 'â€”'}</div>
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 0.9rem; color: #00e8a2; font-weight: 600;">${song.total_plays || 0} plays</div>
                <div style="font-size: 0.85rem; color: #888;">${song.total_emisoras || 0} emisoras</div>
              </div>
            </div>
          </div>
        `).join('');
        
      } catch (err) {
        console.error('Error cargando top:', err);
        document.getElementById('top-songs-list').innerHTML = 
          '<div class="empty" style="color: #f44;">Error cargando datos</div>';
      }
    }

    // ============================================================================
    // CARGAR ÃšLTIMAS REPRODUCCIONES
    // ============================================================================
    async function loadLatestPlays() {
      try {
        const res = await fetch('/api/stats/top_songs?limit=100');
        
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        
        const tbody = document.getElementById('plays-tbody');
        
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">Sin reproducciones</td></tr>';
          return;
        }

        // Tomar solo las primeras 20 para la tabla de "Ãºltimas"
        const recent = data.slice(0, 20);
        
        tbody.innerHTML = recent.map((play, idx) => `
          <tr style="border-bottom: 1px solid #333;">
            <td style="font-size: 0.85rem; color: #aaa;">Hace poco</td>
            <td style="font-size: 0.9rem;">â€”</td>
            <td style="font-size: 0.9rem; color: #fff;">${play.artista || 'â€”'}</td>
            <td style="font-size: 0.9rem; color: #ccc;">${play.titulo || 'â€”'}</td>
            <td style="font-size: 0.8rem; color: #fff; text-align: center;">
              <span style="background: ${
                play.fuente === 'icy' ? '#4caf50' : 
                play.fuente === 'audd' ? '#2196f3' : 
                play.fuente === 'prediccion' ? '#9c27b0' :
                '#ff9800'
              }; padding: 2px 6px; border-radius: 3px; white-space: nowrap;">
                ${getSourceBadge(play.fuente || 'fallback')}
              </span>
            </td>
          </tr>
        `).join('');
        
      } catch (err) {
        console.error('Error cargando plays:', err);
        document.getElementById('plays-tbody').innerHTML = 
          '<tr><td colspan="5" style="text-align: center; color: #f44;">Error cargando reproducciones</td></tr>';
      }
    }

    // ============================================================================
    // ACTUALIZAR ESTADÃSTICAS
    // ============================================================================
    async function updateStats() {
      try {
        const res = await fetch('/api/stats/top_songs?limit=500');
        if (!res.ok) return;
        const data = await res.json();

        if (data && data.length > 0) {
          // Calcular estadÃ­sticas
          const uniqueArtists = new Set(data.map(s => s.artista)).size;
          const uniqueSongs = new Set(data.map(s => `${s.artista}-${s.titulo}`)).size;
          
          // Contar por fuente
          const sources = {};
          data.forEach(s => {
            const source = s.fuente || 'fallback';
            sources[source] = (sources[source] || 0) + 1;
          });
          
          const total = Object.values(sources).reduce((a, b) => a + b, 0);
          
          document.getElementById('stat-unique-songs').textContent = uniqueSongs;
          document.getElementById('stat-unique-artists').textContent = uniqueArtists;
          document.getElementById('stat-active-stations').textContent = '71'; // Hardcoded por ahora
          
          // Porcentajes
          if (total > 0) {
            document.getElementById('stat-icy').textContent = 
              `${Math.round((sources['icy'] || 0) / total * 100)}%`;
            document.getElementById('stat-audd').textContent = 
              `${Math.round((sources['audd'] || 0) / total * 100)}%`;
            document.getElementById('stat-prediccion').textContent = 
              `${Math.round((sources['prediccion'] || 0) / total * 100)}%`;
            document.getElementById('stat-fallback').textContent = 
              `${Math.round((sources['fallback'] || 0) / total * 100)}%`;
          }
        }
      } catch (err) {
        console.error('Error actualizando stats:', err);
      }
    }

    // ============================================================================
    // BUSCAR EN TABLA
    // ============================================================================
    function setupSearch() {
      const searchInput = document.getElementById('filter-play');
      if (!searchInput) return;
      
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#plays-tbody tr');
        
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(query) ? '' : 'none';
        });
      });
    }

    // ============================================================================
    // EXPORTAR CSV
    // ============================================================================
    function setupExport() {
      document.getElementById('export-top-csv')?.addEventListener('click', async () => {
        try {
          const limit = document.getElementById('top-limit').value;
          const res = await fetch(api.topSongs(limit));
          const data = await res.json();
          
          const rows = data.map(s => ({
            titulo: s.titulo,
            artista: s.artista,
            plays: s.total_plays,
            emisoras: s.total_emisoras
          }));
          
          const csv = rowsToCSV(rows, ['titulo', 'artista', 'plays', 'emisoras']);
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `top-canciones-${new Date().toISOString().split('T')[0]}.csv`;
          a.click();
          URL.revokeObjectURL(url);
          showNotification('CSV descargado', 'success');
        } catch (err) {
          showNotification('Error descargando CSV', 'error');
        }
      });

      document.getElementById('export-plays-csv')?.addEventListener('click', async () => {
        try {
          const rows = Array.from(document.querySelectorAll('#plays-tbody tr'))
            .map(row => {
              const cells = row.querySelectorAll('td');
              return {
                hora: cells[0]?.textContent || '',
                emisora: cells[1]?.textContent || '',
                artista: cells[2]?.textContent || '',
                titulo: cells[3]?.textContent || '',
                fuente: cells[4]?.textContent || ''
              };
            });
          
          const csv = rowsToCSV(rows, ['hora', 'emisora', 'artista', 'titulo', 'fuente']);
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `reproducciones-${new Date().toISOString().split('T')[0]}.csv`;
          a.click();
          URL.revokeObjectURL(url);
          showNotification('CSV descargado', 'success');
        } catch (err) {
          showNotification('Error descargando CSV', 'error');
        }
      });
    }

    // ============================================================================
    // CICLO DE AUTO-REFRESH
    // ============================================================================
    let lastRefreshTime = Date.now();
    
    async function autoRefresh() {
      try {
        await loadTopSongs();
        await loadLatestPlays();
        await updateStats();
        lastRefreshTime = Date.now();
        
        // Actualizar indicador
        const status = document.getElementById('sync-status');
        if (status) {
          status.textContent = `âœ“ Actualizado a las ${new Date().toLocaleTimeString('es-ES')}`;
          status.style.color = '#00e8a2';
          status.style.opacity = '1';
          
          // Fade out despuÃ©s de 3s
          setTimeout(() => {
            status.style.opacity = '0.5';
          }, 3000);
        }
      } catch (err) {
        console.error('Error en auto-refresh:', err);
      }
    }

    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================
    document.getElementById('refresh-btn')?.addEventListener('click', async () => {
      const btn = document.getElementById('refresh-btn');
      btn.style.opacity = '0.5';
      btn.disabled = true;
      
      await autoRefresh();
      
      setTimeout(() => {
        btn.style.opacity = '1';
        btn.disabled = false;
      }, 500);
      
      showNotification('Datos actualizados', 'success');
    });

    document.getElementById('top-limit')?.addEventListener('change', loadTopSongs);

    // ============================================================================
    // INICIALIZACIÃ“N
    // ============================================================================
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('ğŸš€ Inicializando Radio Monitor...');
      
      // Cargar datos iniciales
      await autoRefresh();
      setupSearch();
      setupExport();
      
      // Auto-refresh cada 15 segundos
      setInterval(autoRefresh, CONFIG.AUTO_REFRESH_INTERVAL);
      
      // Indicador visual de auto-refresh
      let count = 1;
      const statusInterval = setInterval(() => {
        const status = document.getElementById('sync-status');
        if (status && !status.textContent.includes('Actualizado')) {
          status.textContent = `PrÃ³xima actualizaciÃ³n en ${CONFIG.AUTO_REFRESH_INTERVAL / 1000 - count}s...`;
          status.style.color = '#ffaa00';
          count++;
          if (count > CONFIG.AUTO_REFRESH_INTERVAL / 1000) {
            count = 1;
          }
        }
      }, 1000);
    });

    // ============================================================================
    // ESTILOS
    // ============================================================================
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
      }
      #sync-status {
        transition: all 0.3s ease;
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
